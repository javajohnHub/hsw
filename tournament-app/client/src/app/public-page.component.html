<div id="hover-preview-portal" class="global-hover-portal"></div>
<div class="rnd-bg public-page">
  <!-- DEBUG OVERLAY (temporary) -->
  <div style="position:fixed;top:4px;right:4px;z-index:9999;font-size:11px;background:rgba(0,0,0,0.55);color:#bdfcb9;padding:6px 8px;border:1px solid #53fc19;border-radius:6px;font-family:monospace" *ngIf="true">
    P: {{ players?.length || 0 }} | M: {{ matches?.length || 0 }} | G: {{ games?.length || 0 }} | week: {{ currentWeek }}<br>
    loaded: P{{ playersLoaded? '‚úì':'√ó' }} M{{ matchesLoaded? '‚úì':'√ó' }} G{{ gamesLoaded? '‚úì':'√ó' }}
  </div>
  <div *ngIf="isAdmin" class="admin-banner">
    <span class="admin-pill">Admin</span>
    You are logged in. <a routerLink="/admin">Go to Admin</a>
    <button class="banner-logout" (click)="logout()">Logout</button>
  </div>
  <!-- Debug overlay removed for mobile styles -->
  <div class="rnd-title-card" [class.empty-wheel]="players.length === 0">
    <div class="banner-frame">
      <img
        src="assets/AddText_08-12-04.51.33.png"
        alt="Tournament Banner"
        class="rnd-img animate"
      />
    </div>
  </div>
  <div class="tab-container">
    <div class="tab-nav">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'matchups'"
        (click)="setActiveTab('matchups')"
      >
        This Week
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'standings'"
        (click)="setActiveTab('standings')"
      >
        Standings
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'schedule'"
        (click)="setActiveTab('schedule')"
      >
        Full Schedule
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Current Week Matchups Tab -->
      <div *ngIf="activeTab === 'matchups'" class="tab-panel game-cover-bg"
           [ngStyle]="currentGameImages ? {'background-image': 'linear-gradient(rgba(15, 17, 17, 0.85), rgba(15, 17, 17, 0.92)), url(' + currentGameImages.cover + ')'} : {}">
        <div class="week-header week-header-inline" *ngIf="currentGame && currentGameImages as gi; else basicWeekHeader">
          <div class="wh-image left game-image-container">
            <img
              [src]="gi.cover + '?v=' + currentWeek"
              [alt]="currentGame.name + ' Cover'"
              class="game-cover-image"
            />
            <img
              [src]="gi.cover + '?v=' + currentWeek"
              [alt]="currentGame.name + ' Cover Large Preview'"
              class="game-image-hover-preview hover-preview-cover"
              aria-hidden="true"
              loading="lazy"
            />
          </div>
          <div class="wh-title-center">
            <h2 class="week-title">
              Week {{ currentWeek }} Matchups
              <span *ngIf="currentGame" class="game-name highlight-game">- {{ currentGame?.name }}</span>
            </h2>
          </div>
          <div class="wh-image right multi-image-group">
            <!-- Week 3: rules replaces cart entirely -->
            <ng-container *ngIf="currentWeek === 3; else normalWeeks">
              <div class="game-image-container">
                <img
                  src="assets/week-3-rules.webp?v={{currentWeek}}"
                  alt="Week 3 Rules"
                  class="game-cart-image"
                />
                <img
                  src="assets/week-3-rules.webp?v={{currentWeek}}"
                  alt="Week 3 Rules Large Preview"
                  class="game-image-hover-preview hover-preview-cart"
                  aria-hidden="true"
                  loading="lazy"
                />
              </div>
            </ng-container>
            <ng-template #normalWeeks>
              <!-- Weeks 1 & 2: show cart + rules side-by-side (if cart not missing) -->
              <ng-container *ngIf="currentWeek === 1 || currentWeek === 2; else defaultCartOnly">
                <div class="game-image-container" *ngIf="!isCartMissing(currentGame.name) && currentGameImages">
                  <img
                    [src]="currentGameImages.cart + '?v=' + currentWeek"
                    (error)="onCartImageError($event, currentGame.name)"
                    [alt]="currentGame.name + ' Cartridge'"
                    class="game-cart-image"
                  />
                  <img
                    [src]="currentGameImages.cart + '?v=' + currentWeek"
                    [alt]="currentGame.name + ' Cartridge Large Preview'"
                    class="game-image-hover-preview hover-preview-cart"
                    aria-hidden="true"
                    loading="lazy"
                  />
                </div>
                <div class="game-image-container" *ngIf="getWeekRulesImage(currentWeek) as rulesImg">
                  <img
                    [src]="rulesImg.src + '?v=' + currentWeek"
                    (error)="onRulesImageError($event, currentWeek)"
                    [alt]="rulesImg.alt"
                    class="game-cart-image"
                  />
                  <img
                    [src]="rulesImg.src + '?v=' + currentWeek"
                    [alt]="rulesImg.alt + ' Large Preview'"
                    class="game-image-hover-preview hover-preview-cart"
                    aria-hidden="true"
                    loading="lazy"
                  />
                </div>
              </ng-container>
              <ng-template #defaultCartOnly>
                <div class="game-image-container" *ngIf="!isCartMissing(currentGame.name) && currentGameImages">
                  <img
                    [src]="currentGameImages.cart + '?v=' + currentWeek"
                    (error)="onCartImageError($event, currentGame.name)"
                    [alt]="currentGame.name + ' Cartridge'"
                    class="game-cart-image"
                  />
                  <img
                    [src]="currentGameImages.cart + '?v=' + currentWeek"
                    [alt]="currentGame.name + ' Cartridge Large Preview'"
                    class="game-image-hover-preview hover-preview-cart"
                    aria-hidden="true"
                    loading="lazy"
                  />
                </div>
              </ng-template>
            </ng-template>
          </div>
        </div>
        <ng-template #basicWeekHeader>
          <div class="week-header">
            <h2 class="week-title">Week {{ currentWeek }} Matchups
              <span *ngIf="currentGame" class="game-name highlight-game">- {{ currentGame?.name }}</span>
            </h2>
          </div>
        </ng-template>
        <div *ngIf="!playersLoaded || !matchesLoaded" class="no-matches">
          Loading matchups...
        </div>
        <div *ngIf="playersLoaded && matchesLoaded">
          <div
            class="matchup-grid"
            *ngIf="getMatchupGrid().length > 0; else noMatchups"
          >
            <div *ngFor="let matchup of getMatchupGrid()" class="matchup-card">
              <div class="player-slot">
                <a
                  *ngIf="matchup.player1 && matchup.player1 !== 'TBD'"
                  class="kick-player-link"
                  [href]="getKickProfileUrl(matchup.player1)"
                  target="_blank" rel="noopener"
                  title="Open Kick profile"
                >
                  <img
                    *ngIf="
                      matchup.player1 &&
                      matchup.player1 !== 'TBD' &&
                      !isImageError(matchup.player1)
                    "
                    [src]="'assets/players/' + matchup.player1.toLowerCase() + '.webp'"
                    [alt]="matchup.player1"
                    class="player-image"
                    (error)="onImageError(matchup.player1)"
                  />
                  <span
                    class="player-name fallback-text"
                    *ngIf="
                      !matchup.player1 ||
                      matchup.player1 === 'TBD' ||
                      isImageError(matchup.player1)
                    "
                  >
                    {{ matchup.player1 || 'TBD' }}
                  </span>
                </a>
                <span
                  *ngIf="!matchup.player1 || matchup.player1 === 'TBD'"
                  class="player-name fallback-text"
                >{{ matchup.player1 || 'TBD' }}</span>
              </div>
              <div class="vs-divider" style="color: black;">VS</div>
              <div class="player-slot">
                <a
                  *ngIf="matchup.player2 && matchup.player2 !== 'TBD'"
                  class="kick-player-link"
                  [href]="getKickProfileUrl(matchup.player2)"
                  target="_blank" rel="noopener"
                  title="Open Kick profile"
                >
                  <img
                    *ngIf="
                      matchup.player2 &&
                      matchup.player2 !== 'TBD' &&
                      !isImageError(matchup.player2)
                    "
                    [src]="'assets/players/' + matchup.player2.toLowerCase() + '.webp'"
                    [alt]="matchup.player2"
                    class="player-image"
                    (error)="onImageError(matchup.player2)"
                  />
                  <span
                    class="player-name fallback-text"
                    *ngIf="
                      !matchup.player2 ||
                      matchup.player2 === 'TBD' ||
                      isImageError(matchup.player2)
                    "
                  >
                    {{ matchup.player2 || 'TBD' }}
                  </span>
                </a>
                <span
                  *ngIf="!matchup.player2 || matchup.player2 === 'TBD'"
                  class="player-name fallback-text"
                >{{ matchup.player2 || 'TBD' }}</span>
              </div>
            </div>
          </div>
          <ng-template #noMatchups>
            <div class="no-matches">
              No matchups scheduled for this week.
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Player Standings Tab -->
      <div *ngIf="activeTab === 'standings'" class="tab-panel">
        <h2
          class="section-title"
          style="display: flex; align-items: center; justify-content: center; gap: 10px;"
        >
          Player Standings
          <span class="standings-info-icon" tabindex="0">
            <img src="assets/info.svg" alt="Info" width="22" height="22" />
            <span class="standings-tooltip app-help-tooltip">
              Standings are ranked by points. Hover over a player name for
              detailed stats.
            </span>
          </span>
        </h2>
        <div class="table-container">
          <table class="rnd-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Wins</th>
                <th>Losses</th>
                <th>Not Played</th>
                <th>Points</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let player of getSortedPlayers(); let i = index">
                <td class="rank" data-label="Rank">{{ getPlayerRank(player) }}</td>
                <td class="player-name-cell" data-label="Name">
                  <div class="player-name-stack">
                    <div
                      class="player-help"
                      tabindex="0"
                      (mouseenter)="showPlayerTooltip($event, player.name)"
                      (mouseleave)="hidePlayerTooltip()"
                      (focusin)="showPlayerTooltip($event, player.name)"
                      (focusout)="hidePlayerTooltip()"
                    >
                      <span
                        (click)="openStatsModal(player.name)"
                        class="stats-link player-name"
                        >{{ player.name }}</span
                      >
                      <div
                        *ngIf="currentTooltip.visible && currentTooltip.playerName === player.name"
                        class="player-tooltip"
                        [innerHTML]="currentTooltip.content"
                      ></div>
                    </div>
                    <a
                      class="kick-link inline"
                      [href]="getKickProfileUrl(player.name)"
                      target="_blank"
                      rel="noopener"
                      title="Open Kick profile"
                    >Kick</a>
                  </div>
                </td>
                <td data-label="Wins">{{ player.wins }}</td>
                <td data-label="Losses">{{ player.losses }}</td>
                <td data-label="Not Played">{{ player.notPlayed }}</td>
                <td class="points" data-label="Points">
                  {{ player.points }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Player Stats Modal -->
        <div
          class="stats-modal-backdrop"
          *ngIf="showStatsModal"
          (click)="closeStatsModal()"
        >
          <div class="stats-modal" (click)="$event.stopPropagation()">
            <button
              class="close-modal"
              (click)="closeStatsModal()"
              aria-label="Close"
            >
              √ó
            </button>
            <div class="stats-modal-content">
              <h3>Player Matchup Stats</h3>
              <pre>{{ selectedPlayerStats }}</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Full Schedule Tab -->
      <div *ngIf="activeTab === 'schedule'" class="tab-panel">
        <h2 class="section-title">Tournament Schedule</h2>
        <div
          class="schedule-container"
          [class.force-schedule-column]="isMobile"
        >
          <div *ngFor="let week of getWeeksWithMatches()" class="week-block" [ngStyle]="getWeekBackgroundStyle(week)">
            <h3 class="week-block-title">
              Week {{ week.number }}
              <span *ngIf="week.game" [ngClass]="{'game-name': true, 'highlight-game': week.number === currentWeek}">- {{ week.game?.name }}</span>
              <span
                *ngIf="week.number === currentWeek"
                class="current-week-badge"
                >CURRENT</span
              >
            </h3>
            <div *ngIf="week.game && getGameImages(week.game.name) as wig" class="game-images-schedule">
              <div class="game-image-small schedule-game-image-container">
                <img [src]="wig.cover" [alt]="week.game.name + ' Cover'" class="schedule-game-image" />
                <img [src]="wig.cover" [alt]="week.game.name + ' Cover Large Preview'" class="schedule-hover-preview" aria-hidden="true" loading="lazy" />
              </div>
              <div class="game-image-small schedule-game-image-container" *ngIf="getSecondaryWeekImage(week.number, week.game.name) as sec2">
                <img
                  [src]="sec2.src"
                  *ngIf="sec2.kind === 'rules' || !isCartMissing(week.game.name)"
                  (error)="sec2.kind === 'cart' ? onCartImageError($event, week.game.name) : null"
                  [alt]="sec2.alt"
                  class="schedule-game-image"
                />
                <img [src]="sec2.src" [alt]="sec2.alt + ' Large Preview'" class="schedule-hover-preview" aria-hidden="true" loading="lazy" />
              </div>
              <!-- Explicit rules image for weeks 1 & 2 when both cart and rules should show -->
              <div class="game-image-small schedule-game-image-container" *ngIf="(week.number === 1 || week.number === 2) && getWeekRulesImage(week.number) as rImg">
                <img
                  [src]="rImg.src"
                  (error)="onRulesImageError($event, week.number)"
                  [alt]="rImg.alt"
                  class="schedule-game-image"
                />
                <img [src]="rImg.src" [alt]="rImg.alt + ' Large Preview'" class="schedule-hover-preview" aria-hidden="true" loading="lazy" />
              </div>
            </div>
            <div class="week-matches">
              <div
                *ngFor="let match of week.matches"
                class="schedule-match"
              >
                <div class="match-players">
                  <span class="player1">
                    {{ match.player1 }}
                    <span
                      *ngIf="
                        match.status === 'completed' &&
                        match.winner === match.player1
                      "
                      class="win-badge"
                      title="Winner"
                      >üèÜ</span
                    >
                  </span>
                  <span class="vs">VS</span>
                  <span class="player2">
                    {{ match.player2 }}
                    <span
                      *ngIf="
                        match.status === 'completed' &&
                        match.winner === match.player2
                      "
                      class="win-badge"
                      title="Winner"
                      >üèÜ</span
                    >
                  </span>
                </div>
                <div *ngIf="match.player2 === 'Bye'" class="bye-indicator">
                  BYE WEEK
                </div>
              </div>
              <div
                *ngIf="week.matches.length === 0"
                class="no-matches-week"
              >
                No matches scheduled
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="hover-lift-root">
    <!-- added wrapper for elevated hover previews -->
  </div>
</div>
